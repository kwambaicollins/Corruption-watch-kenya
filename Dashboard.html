<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - Corruption Watch Kenya</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    /* Use your provided dashboard styles here */
    body { font-family: 'Open Sans', sans-serif; background: #f4f4f4; margin: 0; }
    header { background: #006341; color: #fff; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
    .dashboard-container { max-width: 1200px; margin: auto; padding: 1rem; }
    .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .stat-card { background: #fff; padding: 1rem; border-radius: 8px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .chart-container { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    @media (max-width: 768px) { .chart-container { grid-template-columns: 1fr; } }
    .chart-card { background: #fff; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .map-container { height: 500px; }
    .reports-table { width: 100%; border-collapse: collapse; }
    .reports-table th, .reports-table td { padding: 0.75rem; border-bottom: 1px solid #ddd; }
    .status-badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; }
    .status-pending { background: #FFF3CD; color: #856404; }
    .status-investigating { background: #D1ECF1; color: #0C5460; }
    .status-resolved { background: #D4EDDA; color: #155724; }
</style>
</head>
<body>
<header>
    <h1>Corruption Watch Kenya - Dashboard</h1>
    <a href="index.html" style="color:#fff;"><i class="fas fa-home"></i> Home</a>
</header>

<div class="dashboard-container">
    <div class="stats-container">
        <div class="stat-card"><h3>Total Reports</h3><div id="totalReports">0</div></div>
        <div class="stat-card"><h3>Under Investigation</h3><div id="investigating">0</div></div>
        <div class="stat-card"><h3>Resolved Cases</h3><div id="resolved">0</div></div>
        <div class="stat-card"><h3>Hotspot Regions</h3><div id="hotspots">0</div></div>
    </div>

    <div class="chart-container">
        <div class="chart-card"><h3>Reports by Corruption Type</h3><canvas id="typeChart"></canvas></div>
        <div class="chart-card"><h3>Monthly Trend</h3><canvas id="trendChart"></canvas></div>
    </div>

    <div class="chart-card">
        <h3>Corruption Heatmap - Kenya</h3>
        <div class="map-container" id="heatmap"></div>
    </div>

    <div class="chart-card">
        <h3>Resolution Status</h3>
        <canvas id="statusChart"></canvas>
    </div>

    <div class="chart-card">
        <h3>Case Tracking Section</h3>
        <table class="reports-table" id="casesTable">
            <thead>
                <tr><th>Case ID</th><th>Type</th><th>Location</th><th>Date</th><th>Status</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<footer style="text-align:center; padding:1rem; background:#333; color:#fff;">
    Corruption Watch Kenya &copy; 2025
</footer>

<!-- JS Libraries -->
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// Firebase Config
const firebaseConfig = {
    apiKey: "AIzaSyD7NFb1hFX3VFzfbJ0UmY-mDby-6w3MYuk",
    authDomain: "corruption-watch-kenya.firebaseapp.com",
    databaseURL: "https://corruption-watch-kenya-default-rtdb.firebaseio.com",
    projectId: "corruption-watch-kenya",
    storageBucket: "corruption-watch-kenya.appspot.com",
    messagingSenderId: "1032330075769",
    appId: "1:1032330075769:web:6e5f0d984d95cec8c5bea8"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function loadDashboardData() {
    db.ref("reports").on("value", snapshot => {
        const reports = snapshot.val() || {};
        let total = 0, investigating = 0, resolved = 0;
        let typeCounts = {}, statusCounts = {pending:0, investigating:0, resolved:0};
        let monthlyCounts = Array(12).fill(0);
        let heatmapPoints = [];

        for (let id in reports) {
            let r = reports[id];
            total++;
            if (statusCounts[r.status] !== undefined) statusCounts[r.status]++;
            typeCounts[r.type] = (typeCounts[r.type] || 0) + 1;
            if (r.status === "investigating") investigating++;
            if (r.status === "resolved") resolved++;
            let month = new Date(r.date).getMonth();
            monthlyCounts[month]++;
            if (r.lat && r.lng) heatmapPoints.push([parseFloat(r.lat), parseFloat(r.lng), 0.5]);
        }

        document.getElementById("totalReports").textContent = total;
        document.getElementById("investigating").textContent = investigating;
        document.getElementById("resolved").textContent = resolved;
        document.getElementById("hotspots").textContent = new Set(heatmapPoints.map(p => `${p[0]},${p[1]}`)).size;

        renderTypeChart(typeCounts);
        renderTrendChart(monthlyCounts);
        renderStatusChart(statusCounts);
        renderHeatmap(heatmapPoints);
        populateCasesTable(reports);
    });
}

function renderTypeChart(typeCounts) {
    new Chart(document.getElementById("typeChart"), {
        type: 'doughnut',
        data: {
            labels: Object.keys(typeCounts),
            datasets: [{ data: Object.values(typeCounts), backgroundColor: ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF'] }]
        }
    });
}

function renderTrendChart(monthlyCounts) {
    new Chart(document.getElementById("trendChart"), {
        type: 'line',
        data: { labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
                datasets: [{ label: 'Reports', data: monthlyCounts, borderColor: '#006341', fill: false }] }
    });
}

function renderStatusChart(statusCounts) {
    new Chart(document.getElementById("statusChart"), {
        type: 'bar',
        data: { labels: ['Pending', 'Investigating', 'Resolved'],
                datasets: [{ data: [statusCounts.pending, statusCounts.investigating, statusCounts.resolved],
                             backgroundColor: ['#FFF3CD','#D1ECF1','#D4EDDA'] }] }
    });
}

function renderHeatmap(points) {
    const map = L.map('heatmap').setView([0.0236, 37.9062], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    if (points.length > 0) L.heatLayer(points, { radius: 25 }).addTo(map);
}

function populateCasesTable(reports) {
    const tbody = document.querySelector("#casesTable tbody");
    tbody.innerHTML = "";
    for (let id in reports) {
        let r = reports[id];
        let tr = document.createElement("tr");
        tr.innerHTML = `<td>${id}</td>
                        <td>${r.type}</td>
                        <td>${r.location}</td>
                        <td>${r.date}</td>
                        <td><span class="status-badge status-${r.status}">${r.status}</span></td>`;
        tbody.appendChild(tr);
    }
}

loadDashboardData();
</script>
</body>
</html>
