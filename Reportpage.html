<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Report Corruption</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: auto;
      padding: 20px;
    }
    #map {
      height: 300px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
    }
    input, select, textarea, button {
      width: 100%;
      margin-bottom: 15px;
      padding: 10px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    button {
      background-color: #006341;
      color: white;
      border: none;
      cursor: pointer;
    }
    .error {
      color: red;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h2>Report Corruption Case</h2>
  <div id="error" class="error"></div>
  <form id="reportForm">
    <label for="corruptionType">Type of Corruption</label>
    <select id="corruptionType" required>
      <option value="">Select...</option>
      <option value="Bribery">Bribery</option>
      <option value="Embezzlement">Embezzlement</option>
      <option value="Fraud">Fraud</option>
      <option value="Nepotism">Nepotism</option>
      <option value="Other">Other</option>
    </select>

    <label for="description">Description</label>
    <textarea id="description" required placeholder="Provide detailed information..."></textarea>

    <label for="peopleInvolved">People Involved</label>
    <input type="text" id="peopleInvolved" placeholder="Names or organizations (optional)" />

    <label>Click on the Map to Select Location</label>
    <div id="map"></div>
    <input type="text" id="location" placeholder="Location will appear here..." readonly required />

    <label for="dateOccurred">Date Occurred</label>
    <input type="date" id="dateOccurred" required />

    <button type="submit">Submit Report</button>
  </form>

  <!-- JS Libraries -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD7NFb1hFX3VFzfbJ0UmY-mDby-6w3MYuk",
      authDomain: "corruption-watch-kenya.firebaseapp.com",
      databaseURL: "https://corruption-watch-kenya-default-rtdb.firebaseio.com",
      projectId: "corruption-watch-kenya",
      storageBucket: "corruption-watch-kenya.appspot.com",
      messagingSenderId: "1032330075769",
      appId: "1:1032330075769:web:6e5f0d984d95cec8c5bea8"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const reportForm = document.getElementById('reportForm');
    const locationInput = document.getElementById('location');
    const errorDiv = document.getElementById('error');

    let marker;

    // Reverse geocode
    async function getLocationName(lat, lng) {
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
        const data = await response.json();
        const addr = data.address;
        return `${addr.county || ''}, ${addr.town || addr.city || ''}, ${addr.suburb || addr.village || ''}`.replace(/,+$/, '').trim();
      } catch (err) {
        return "Unknown Location";
      }
    }

    // Initialize map
    const map = L.map('map').setView([-1.2921, 36.8219], 7); // Nairobi
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    marker = L.marker([-1.2921, 36.8219], { draggable: true }).addTo(map);

    async function updateLocation(lat, lng) {
      const name = await getLocationName(lat, lng);
      locationInput.value = name;
    }

    marker.on('dragend', async () => {
      const pos = marker.getLatLng();
      await updateLocation(pos.lat, pos.lng);
    });

    map.on('click', async (e) => {
      marker.setLatLng(e.latlng);
      await updateLocation(e.latlng.lat, e.latlng.lng);
    });

    updateLocation(-1.2921, 36.8219); // initial

    reportForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorDiv.textContent = "";

      const type = document.getElementById('corruptionType').value.trim();
      const desc = document.getElementById('description').value.trim();
      const people = document.getElementById('peopleInvolved').value.trim();
      const locationName = locationInput.value.trim();
      const date = document.getElementById('dateOccurred').value.trim();

      if (!type || !desc || !locationName || !date) {
        errorDiv.textContent = "Please fill in all required fields.";
        return;
      }

      const report = {
        corruptionType: type,
        description: desc,
        peopleInvolved: people || "Not specified",
        location: locationName,
        dateOccurred: date,
        timestamp: new Date().toISOString()
      };

      try {
        const newRef = db.ref("reports").push();
        await newRef.set(report);
        alert("Report submitted successfully.");
        reportForm.reset();
        locationInput.value = "";
      } catch (error) {
        errorDiv.textContent = "Submission failed. Please try again.";
        console.error(error);
      }
    });
  </script>
</body>
</html>
