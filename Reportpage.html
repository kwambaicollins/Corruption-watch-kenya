<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Report Corruption</title>
  <!-- Load CSS first -->
  <link href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
    }
    textarea {
      min-height: 100px;
    }
    #map {
      height: 300px;
      margin: 10px 0;
      border: 1px solid #ddd;
    }
    @media (max-width: 600px) {
      #map {
        height: 200px;
      }
      input, select, textarea, button {
        font-size: 1.1rem;
        padding: 16px;
      }
    }
    button {
      background: #006341;
      color: white;
      border: none;
      padding: 14px 15px;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
      font-size: 1.1rem;
    }
    .error-message {
      color: #BB0000;
      margin-bottom: 10px;
      font-weight: bold;
    }
    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      flex-direction: column;
    }
    .retry-button {
      margin-top: 20px;
      padding: 10px 20px;
      background: #006341;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <!-- Loading overlay -->
  <div id="loadingOverlay">
    <div id="loadingMessage">Loading application resources...</div>
    <div id="loadingProgress"></div>
    <button id="retryButton" class="retry-button hidden">Retry Loading</button>
  </div>

  <!-- Main content (initially hidden) -->
  <div id="mainContent" class="hidden">
    <h1>Report Corruption Case</h1>
    <form id="reportForm" novalidate>
      <div class="error-message" id="formError" style="display:none;"></div>
      <div class="form-group">
        <label for="corruptionType">Type of Corruption</label>
        <select id="corruptionType" name="corruptionType" required>
          <option value="">Select type...</option>
          <option value="bribery">Bribery</option>
          <option value="embezzlement">Embezzlement</option>
          <option value="fraud">Fraud</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="form-group">
        <label for="description">Description</label>
        <textarea id="description" name="description" required></textarea>
      </div>
      <div class="form-group">
        <label>Location</label>
        <div id="map" aria-label="Map for selecting location" tabindex="0"></div>
        <input type="text" id="location" name="location" readonly aria-label="Selected location">
        <input type="hidden" id="latitude" name="latitude">
        <input type="hidden" id="longitude" name="longitude">
      </div>
      <div class="form-group">
        <label for="dateOccurred">Date Occurred</label>
        <input type="date" id="dateOccurred" name="dateOccurred" required>
      </div>
      <button type="submit" id="submitBtn" disabled>Submit Report</button>
    </form>
  </div>

  <script>
    // Configuration
    const CONFIG = {
      firebase: {
        apiKey: "AIzaSyD7NFb1hFX3VFzfbJ0UmY-mDby-6w3MYuk",
        authDomain: "corruption-watch-kenya.firebaseapp.com",
        databaseURL: "https://corruption-watch-kenya-default-rtdb.firebaseio.com",
        projectId: "corruption-watch-kenya",
        storageBucket: "corruption-watch-kenya.appspot.com",
        messagingSenderId: "1032330075769",
        appId: "1:1032330075769:web:6e5f0d984d95cec8c5bea8",
        measurementId: "G-TZJZCMY0ME"
      },
      map: {
        defaultLat: 0.0236,
        defaultLng: 37.9062,
        defaultZoom: 6
      }
    };

    // Global state
    const state = {
      firebase: null,
      db: null,
      map: null,
      marker: null,
      loadedResources: {
        leaflet: false,
        firebaseApp: false,
        firebaseDB: false
      }
    };

    // DOM elements
    const elements = {
      loadingOverlay: document.getElementById('loadingOverlay'),
      loadingMessage: document.getElementById('loadingMessage'),
      loadingProgress: document.getElementById('loadingProgress'),
      retryButton: document.getElementById('retryButton'),
      mainContent: document.getElementById('mainContent'),
      formError: document.getElementById('formError'),
      reportForm: document.getElementById('reportForm'),
      submitBtn: document.getElementById('submitBtn')
    };

    // Utility functions
    function updateLoadingStatus(message) {
      elements.loadingMessage.textContent = message;
      elements.loadingProgress.textContent = getLoadingProgress();
    }

    function getLoadingProgress() {
      const loaded = Object.values(state.loadedResources).filter(Boolean).length;
      const total = Object.keys(state.loadedResources).length;
      return `Loaded ${loaded} of ${total} required resources`;
    }

    function showError(message, showRetry = true) {
      elements.formError.textContent = message;
      elements.formError.style.display = 'block';
      elements.retryButton.classList.toggle('hidden', !showRetry);
    }

    function clearError() {
      elements.formError.textContent = '';
      elements.formError.style.display = 'none';
    }

    function showMainContent() {
      elements.loadingOverlay.classList.add('hidden');
      elements.mainContent.classList.remove('hidden');
    }

    // Resource loading
    function loadScript(src, resourceName) {
      return new Promise((resolve, reject) => {
        updateLoadingStatus(`Loading ${resourceName}...`);
        
        const script = document.createElement('script');
        script.src = src;
        script.onload = () => {
          state.loadedResources[resourceName] = true;
          updateLoadingStatus(`${resourceName} loaded successfully`);
          resolve();
        };
        script.onerror = () => {
          reject(new Error(`Failed to load ${resourceName}`));
        };
        document.head.appendChild(script);
      });
    }

    // Initialize Firebase
    function initializeFirebase() {
      try {
        updateLoadingStatus('Initializing Firebase...');
        state.firebase = firebase.initializeApp(CONFIG.firebase);
        state.db = firebase.database();
        return true;
      } catch (error) {
        console.error('Firebase initialization error:', error);
        showError('Failed to initialize database. Please try again later.');
        return false;
      }
    }

    // Initialize Map
    function initializeMap() {
      try {
        updateLoadingStatus('Initializing map...');
        state.map = L.map('map').setView(
          [CONFIG.map.defaultLat, CONFIG.map.defaultLng], 
          CONFIG.map.defaultZoom
        );
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(state.map);
        
        state.marker = L.marker(
          [CONFIG.map.defaultLat, CONFIG.map.defaultLng], 
          { draggable: true }
        ).addTo(state.map);
        
        // Initialize map marker
        state.marker.bindPopup(`Lat: ${CONFIG.map.defaultLat}, Lng: ${CONFIG.map.defaultLng}`).openPopup();
        setLocationFields(CONFIG.map.defaultLat, CONFIG.map.defaultLng);

        // Map event handlers
        state.marker.on('dragend', () => {
          const { lat, lng } = state.marker.getLatLng();
          state.marker.setPopupContent(`Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`).openPopup();
          setLocationFields(lat, lng);
          validateForm();
        });

        state.map.on('click', (e) => {
          state.marker.setLatLng(e.latlng);
          const { lat, lng } = e.latlng;
          state.marker.setPopupContent(`Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`).openPopup();
          setLocationFields(lat, lng);
          validateForm();
        });

        return true;
      } catch (error) {
        console.error('Map initialization error:', error);
        showError('Failed to initialize map. Please try again later.');
        return false;
      }
    }

    function setLocationFields(lat, lng) {
      document.getElementById('latitude').value = lat;
      document.getElementById('longitude').value = lng;
      document.getElementById('location').value = `Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`;
    }

    // Form validation
    function validateForm() {
      const requiredFields = [
        'corruptionType', 'description', 'latitude', 'longitude', 'dateOccurred'
      ];

      let valid = true;
      for (const id of requiredFields) {
        const el = document.getElementById(id);
        if (!el.value || (el.type === 'select-one' && el.selectedIndex === 0)) {
          valid = false;
          break;
        }
      }
      elements.submitBtn.disabled = !valid;
    }

    // Initialize form
    function initializeForm() {
      // Set default date
      document.getElementById('dateOccurred').value = new Date().toISOString().split('T')[0];

      // Add validation listeners
      const requiredFields = [
        'corruptionType', 'description', 'latitude', 'longitude', 'dateOccurred'
      ];

      requiredFields.forEach(id => {
        document.getElementById(id).addEventListener('input', validateForm);
      });
      validateForm();

      // Form submission handler
      elements.reportForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        clearError();
        const btn = elements.submitBtn;
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Submitting...';

        try {
          const reportData = {
            corruption_type: document.getElementById('corruptionType').value,
            description: document.getElementById('description').value,
            location: document.getElementById('location').value,
            latitude: parseFloat(document.getElementById('latitude').value),
            longitude: parseFloat(document.getElementById('longitude').value),
            date_occurred: document.getElementById('dateOccurred').value,
            created_at: new Date().toISOString(),
            status: 'pending'
          };

          const newReportRef = state.db.ref('reports').push();
          await newReportRef.set(reportData);

          alert('Report submitted successfully! Reference ID: ' + newReportRef.key);
          
          // Reset form
          elements.reportForm.reset();
          state.marker.setLatLng([CONFIG.map.defaultLat, CONFIG.map.defaultLng]);
          state.map.setView([CONFIG.map.defaultLat, CONFIG.map.defaultLng], CONFIG.map.defaultZoom);
          setLocationFields(CONFIG.map.defaultLat, CONFIG.map.defaultLng);
          document.getElementById('dateOccurred').value = new Date().toISOString().split('T')[0];
          validateForm();

        } catch (err) {
          console.error('Submission error:', err);
          showError('Error submitting report: ' + err.message);
        } finally {
          btn.disabled = false;
          btn.textContent = originalText;
        }
      });
    }

    // Retry button handler
    elements.retryButton.addEventListener('click', () => {
      window.location.reload();
    });

    // Main initialization
    async function initializeApp() {
      try {
        // Load Leaflet
        await loadScript('https://unpkg.com/leaflet@1.9.3/dist/leaflet.js', 'leaflet')
          .catch(error => {
            throw new Error('Map library failed to load. Please check your internet connection.');
          });

        // Load Firebase
        await loadScript('https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js', 'firebaseApp')
          .catch(error => {
            throw new Error('Firebase core failed to load. Please check your internet connection.');
          });

        await loadScript('https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js', 'firebaseDB')
          .catch(error => {
            throw new Error('Firebase database failed to load. Please check your internet connection.');
          });

        // Initialize services
        if (!initializeFirebase()) return;
        if (!initializeMap()) return;

        // Initialize form
        initializeForm();

        // Show main content
        showMainContent();
      } catch (error) {
        console.error('Initialization error:', error);
        showError(error.message);
        updateLoadingStatus('Initialization failed: ' + error.message);
      }
    }

    // Start the application
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>