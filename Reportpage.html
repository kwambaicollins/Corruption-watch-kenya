<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Report Corruption</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: auto;
      padding: 20px;
    }
    #map {
      height: 300px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
    }
    input, select, textarea, button, progress {
      width: 100%;
      margin-bottom: 15px;
      padding: 10px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    button {
      background-color: #006341;
      color: white;
      border: none;
      cursor: pointer;
    }
    .error {
      color: red;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h2>Report Corruption Case</h2>
  <div id="error" class="error"></div>
  <form id="reportForm">
    <label for="corruptionType">Type of Corruption</label>
    <select id="corruptionType" required>
      <option value="">Select...</option>
      <option value="Bribery">Bribery</option>
      <option value="Embezzlement">Embezzlement</option>
      <option value="Fraud">Fraud</option>
      <option value="Nepotism">Nepotism</option>
      <option value="Other">Other</option>
    </select>

    <label for="description">Description</label>
    <textarea id="description" required placeholder="Provide detailed information..."></textarea>

    <label for="peopleInvolved">People Involved</label>
    <input type="text" id="peopleInvolved" placeholder="Names or organizations (optional)" />

    <label>Click on the Map to Select Location</label>
    <div id="map"></div>
    <input type="text" id="location" placeholder="Location will appear here..." readonly required />

    <label for="dateOccurred">Date Occurred</label>
    <input type="date" id="dateOccurred" required />

    <label for="evidenceFile">Upload Evidence File (optional)</label>
    <input type="file" id="evidenceFile" accept=".jpg,.jpeg,.png,.pdf" />

    <progress id="uploadProgress" value="0" max="100" style="display:none;"></progress>

    <button type="submit">Submit Report</button>
  </form>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    
    // Your Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD7NFb1hFX3VFzfbJ0UmY-mDby-6w3MYuk",
      authDomain: "corruption-watch-kenya.firebaseapp.com",
      databaseURL: "https://corruption-watch-kenya-default-rtdb.firebaseio.com",
      projectId: "corruption-watch-kenya",
      storageBucket: "corruption-watch-kenya.appspot.com",
      messagingSenderId: "1032330075769",
      appId: "1:1032330075769:web:6e5f0d984d95cec8c5bea8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const reportForm = document.getElementById('reportForm');
    const locationInput = document.getElementById('location');
    const errorDiv = document.getElementById('error');
    const progressBar = document.getElementById('uploadProgress');
    const submitButton = document.querySelector('button[type="submit"]');

    let marker;

    // Generates a unique case ID
    function generateCaseId() {
      const timestamp = Date.now().toString(36);
      const randomPart = Math.random().toString(36).substring(2, 8);
      return `CWK-${timestamp}-${randomPart}`.toUpperCase();
    }

    async function getLocationName(lat, lng) {
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
        const data = await response.json();
        const addr = data.address;
        const parts = [addr.city || addr.town || addr.village, addr.county, addr.state, addr.country];
        return parts.filter(Boolean).join(', ') || "Unknown Location";
      } catch (error) {
        console.error("Geocoding failed:", error);
        return "Unknown Location";
      }
    }

    const map = L.map('map').setView([-1.2921, 36.8219], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    marker = L.marker([-1.2921, 36.8219], { draggable: true }).addTo(map);

    async function updateLocation(lat, lng) {
      const name = await getLocationName(lat, lng);
      locationInput.value = name;
    }

    marker.on('dragend', async () => {
      const pos = marker.getLatLng();
      await updateLocation(pos.lat, pos.lng);
    });

    map.on('click', async (e) => {
      marker.setLatLng(e.latlng);
      await updateLocation(e.latlng.lat, e.latlng.lng);
    });

    updateLocation(-1.2921, 36.8219);
    
    // --- New simulated upload function ---
    function simulateFileUpload(file) {
      return new Promise(resolve => {
        progressBar.style.display = "block";
        submitButton.disabled = true;

        let progress = 0;
        const interval = setInterval(() => {
          progress += 10;
          progressBar.value = progress;
          if (progress >= 100) {
            clearInterval(interval);
            setTimeout(() => {
              progressBar.style.display = "none";
              submitButton.disabled = false;
              resolve("Simulated Upload Complete");
            }, 500); // Small delay to show completion
          }
        }, 200); // Progress every 200ms
      });
    }

    reportForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorDiv.textContent = "";

      const type = document.getElementById('corruptionType').value.trim();
      const desc = document.getElementById('description').value.trim();
      const people = document.getElementById('peopleInvolved').value.trim();
      const locationName = locationInput.value.trim();
      const date = document.getElementById('dateOccurred').value.trim();
      const evidenceFile = document.getElementById('evidenceFile').files[0];
      
      if (!type || !desc || !locationName || !date) {
        errorDiv.textContent = "Please fill in all required fields.";
        return;
      }
      
      const caseId = generateCaseId();
      const newReportRef = ref(db, `reports/${caseId}`);
      let fileUrl = "No file uploaded";

      try {
        if (evidenceFile) {
          fileUrl = await simulateFileUpload(evidenceFile);
        }

        const reportData = {
          caseId: caseId,
          corruptionType: type,
          description: desc,
          peopleInvolved: people || "Not specified",
          location: locationName,
          dateOccurred: date,
          evidenceFileUrl: fileUrl,
          latitude: marker.getLatLng().lat,
          longitude: marker.getLatLng().lng,
          timestamp: new Date().toISOString(),
          status: "pending" // Default status for new reports
        };

        await set(newReportRef, reportData);

        alert(`Report submitted successfully. Your case ID is: ${caseId}`);
        window.location.href = 'index.html';

      } catch (error) {
        errorDiv.textContent = "Submission failed. Please try again.";
        console.error("Submission error:", error);
        submitButton.disabled = false;
        progressBar.style.display = "none";
      }
    });
  </script>
</body>
</html>
